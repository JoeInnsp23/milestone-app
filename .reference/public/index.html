<!DOCTYPE html>
<html lang="en" itemscope itemtype="https://schema.org/WebPage" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Milestone Projects P&L Dashboard - Real-time financial data visualization for project profitability analysis">
    <meta name="robots" content="index,follow">
    <meta name="generator" content="Milestone Dashboard v1.0">
    <meta name="referrer" content="no-referrer">
    <meta itemprop="datePublished" content="2024-01-01T00:00:00+00:00">
    <meta itemprop="dateModified" content="2024-09-17T00:00:00+00:00">
    <meta itemprop="author" content="Build By Milestone Projects">
    <meta itemprop="publisher" content="Innspired Accountancy">
    <meta itemprop="inLanguage" content="en-US">

    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Build By Milestone Projects Dashboard">
    <meta property="og:description" content="P&L Dashboard showing real-time financial data visualization for project profitability analysis">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://dashboard.innspiredaccountancy.com">
    <meta property="og:site_name" content="Build By Milestone">
    <meta property="og:locale" content="en_US">
    <meta property="og:updated_time" content="2024-09-17T00:00:00+00:00">
    <meta property="article:published_time" content="2024-01-01T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-09-17T00:00:00+00:00">

    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Build By Milestone Projects Dashboard">
    <meta name="twitter:description" content="Real-time financial data visualization for project profitability analysis">

      <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; connect-src 'self' https://n8n.innspiredaccountancy.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; img-src 'self' data:; upgrade-insecure-requests;">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    
    <!-- Dashboard Styles and Scripts -->
    <link rel="stylesheet" href="/milestone/css/dashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/milestone/js/dashboard.js" defer></script>

    <title itemprop="name">Build By Milestone Projects Dashboard</title>
    <style>
        /* Loading page specific overrides - white text for loading screen */
        :root {
            /* Override text colors for loading page only */
            --loading-text-primary: #ffffff;
            --loading-text-secondary: rgba(255, 255, 255, 0.9);
            --loading-text-muted: rgba(255, 255, 255, 0.7);
            --loading-text-dim: rgba(255, 255, 255, 0.5);
        }

        [data-theme="dark"] {
            /* Keep dark mode text for loading page */
            --loading-text-primary: #e8e8e8;
            --loading-text-secondary: rgba(232, 232, 232, 0.9);
            --loading-text-muted: rgba(168, 168, 168, 0.7);
            --loading-text-dim: rgba(168, 168, 168, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Smooth theme transitions */
        * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        /* Optimize performance for animations */
        .crane, .hook, .progress-fill {
            will-change: transform;
        }

        body.theme-changing * {
            transition-duration: 0.1s !important;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            margin: 0;
            padding: 0;
        }

        /* Use loading-specific text colors for loading page */
        body:not(.dashboard-loaded) {
            color: var(--loading-text-primary);
        }

        /* Loading page specific styles */
        body:not(.dashboard-loaded) {
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        body:not(.dashboard-loaded)::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 10px,
                    rgba(255, 255, 255, 0.03) 10px,
                    rgba(255, 255, 255, 0.03) 20px
                );
            pointer-events: none;
        }

        .loading-container {
            text-align: center;
            max-width: 400px;
            padding: 2rem;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .logo {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 2rem;
            letter-spacing: -0.02em;
            text-transform: uppercase;
            position: relative;
            display: block;
            padding-right: 3rem;
            text-align: center;
        }

        .logo::after {
            content: 'üèóÔ∏è';
            position: absolute;
            right: 0;
            top: 0;
            font-size: 1.2em;
            animation: bounce 2s ease-in-out infinite;
            will-change: transform;
        }

        @media (max-width: 480px) {
            .logo {
                font-size: 2rem;
                padding-right: 2.5rem;
            }

            .logo::after {
                font-size: 1.5rem;
            }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .construction-spinner {
            width: 80px;
            height: 80px;
            margin: 0 auto 2rem;
            position: relative;
        }

        .crane {
            width: 4px;
            height: 60px;
            background: var(--accent-cyan);
            position: absolute;
            left: 38px;
            top: 10px;
            transform-origin: bottom center;
            animation: crane-swing 3s ease-in-out infinite;
            will-change: transform;
        }

        .crane::before {
            content: '';
            width: 40px;
            height: 3px;
            background: var(--accent-teal);
            position: absolute;
            top: 0;
            left: -18px;
        }

        .hook {
            width: 2px;
            height: 20px;
            background: var(--loading-text-muted);
            position: absolute;
            left: -1px;
            top: 0;
            animation: hook-drop 2s ease-in-out infinite;
            will-change: transform;
        }

        .base {
            width: 60px;
            height: 8px;
            background: var(--primary-blue-darker);
            position: absolute;
            bottom: 0;
            left: 10px;
            border-radius: 2px;
        }

        @keyframes crane-swing {
            0%, 100% { transform: rotate(-10deg); }
            50% { transform: rotate(10deg); }
        }

        @keyframes hook-drop {
            0%, 100% { height: 20px; }
            50% { height: 35px; }
        }

        .loading-message {
            font-size: 1.125rem;
            margin-bottom: 0.5rem;
            color: var(--loading-text-secondary);
            transition: opacity 0.3s ease;
        }

        .loading-message.fade {
            opacity: 0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-overlay);
            border-radius: 4px;
            overflow: hidden;
            margin: 2rem 0;
            position: relative;
        }

        .progress-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: sweep 2s linear infinite;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-teal));
            border-radius: var(--border-radius);
            width: 0%;
            animation: progress 3s ease-in-out infinite;
            box-shadow: 0 0 10px var(--shadow-cyan-hover);
            will-change: width;
        }

        @keyframes progress {
            0% { width: 0%; }
            50% { width: 75%; }
            100% { width: 100%; }
        }

        @keyframes sweep {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .error-container {
            display: none;
            text-align: center;
        }

        .error-message {
            background: var(--bg-error);
            border: 1px solid var(--bg-error-border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: var(--text-primary);
        }

        .retry-button {
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-teal));
            color: var(--text-on-accent);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius-lg);
            font-size: 0.875rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--animation-timing) ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px var(--shadow-cyan);
            outline: 2px solid transparent;
            outline-offset: 2px;
        }

        .retry-button:hover {
            background: linear-gradient(135deg, var(--accent-teal), var(--accent-teal-dark));
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--shadow-cyan-hover);
        }

        .retry-button:focus {
            outline: 2px solid var(--outline-focus);
            outline-offset: 2px;
        }

        .retry-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px var(--shadow-cyan);
        }

        .cache-controls {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            font-size: 0.75rem;
            color: var(--loading-text-muted);
            z-index: 1000;
        }

        .cache-controls.hidden {
            display: none;
        }

        .clear-cache {
            background: none;
            border: 1px solid var(--border-light);
            color: var(--text-primary);
            padding: 0.25rem 0.5rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.75rem;
            margin-left: 0.5rem;
            outline: 1px solid transparent;
            outline-offset: 1px;
            transition: all var(--animation-timing) ease;
        }

        .clear-cache:hover {
            background: var(--bg-overlay);
        }

        .clear-cache:focus {
            outline: 1px solid var(--outline-focus);
            background: var(--bg-overlay);
        }

        /* Focus visible styles for keyboard navigation */
        .retry-button:focus-visible,
        .clear-cache:focus-visible {
            outline: 2px solid var(--outline-focus);
            outline-offset: 2px;
            box-shadow: 0 0 0 3px var(--outline-shadow);
        }

        /* Skip navigation link for accessibility */
        .skip-nav {
            position: absolute;
            top: -40px;
            left: 6px;
            background: var(--accent-cyan);
            color: var(--text-on-accent);
            padding: 8px 16px;
            text-decoration: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            z-index: 1001;
            transition: top var(--animation-timing) ease;
        }

        .skip-nav:focus {
            top: 6px;
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .retry-button {
                border: 2px solid currentColor;
            }

            .clear-cache {
                border: 1px solid currentColor;
            }
        }

        /* Reduced motion preference */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0ms !important;
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            .retry-button:focus {
                outline-color: var(--outline-focus);
            }

            .clear-cache:focus {
                outline-color: var(--outline-focus);
            }
        }

    </style>
</head>
<body>
    <a href="#main-content" class="skip-nav">Skip to main content</a>

    <main id="main-content">
          <div class="loading-container" id="loadingContainer" aria-busy="true">
            <div class="logo">Build By Milestone</div>
            <div class="construction-spinner" role="img" aria-label="Construction spinner loading dashboard">
                <div class="crane">
                    <div class="hook"></div>
                </div>
                <div class="base"></div>
            </div>
            <div class="loading-message" id="loadingMessage" aria-live="polite">Initializing...</div>
            <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-label="Loading progress">
                <div class="progress-fill"></div>
            </div>
        </div>
    </main>

    <!-- Dashboard container for dynamic content -->
    <div id="dashboard-container"></div>

    <div class="error-container" id="errorContainer" role="alert" aria-live="assertive">
        <div class="logo">Build By Milestone</div>
        <div class="error-message" id="errorMessage">
            Unable to load dashboard. Please check your connection and try again.
        </div>
        <button class="retry-button" id="retryButton" aria-label="Retry loading dashboard">Retry</button>
    </div>

    <div class="cache-controls hidden" id="cacheControls" role="status">
        <span>Cached: <span id="cacheTime"></span></span>
        <button class="clear-cache" id="clearCacheButton" aria-label="Clear dashboard cache">Clear Cache</button>
    </div>

    <script>
        // Initialize theme immediately before DOM is ready
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);

        // Configuration
        const WEBHOOK_URL = 'https://n8n.innspiredaccountancy.com/webhook/milestone-dashboard';
        const CACHE_FILE_URL = '/milestone/dashboard-data.json'; // Server-side cached JSON
        const TIMEOUT_MS = 120000; // 120 seconds
        const CACHE_KEY = 'milestone-dashboard-html';
        const CACHE_TTL = 3600000; // 1 hour in localStorage
        const SERVER_CACHE_TTL = 86400000; // 24 hours for server cache
        const MAX_RETRIES = 3;
        const RETRY_DELAY = 2000; // Start with 2 seconds

        // Loading messages
        const loadingMessages = [
            'üèóÔ∏è Laying foundation...',
            'üìê Reading blueprints...',
            'üîß Assembling framework...',
            'üìä Installing project metrics...',
            'üèóÔ∏è Building financial reports...',
            'üîç Quality inspection...',
            'üéØ Finalizing dashboard...'
        ];

        let currentMessageIndex = 0;
        let retryCount = 0;
        let messageInterval;
        let countdownInterval;

        // Theme preference initialization
        function initializeThemePreference() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            // Start loading message rotation
            startMessageRotation();

            // Try loading from server cache first (instant load)
            const serverCached = await fetchServerCache();
            if (serverCached) {
                processAndRenderDashboard(serverCached);
                return;
            }

            // Check for localStorage cache as fallback
            const cached = getCachedDashboard();
            if (cached) {
                loadCachedDashboard(cached.data);
            } else {
                // No cache available, fetch from webhook
                fetchDashboard();
            }

            // Add event listeners for buttons
            const retryButton = document.getElementById('retryButton');
            if (retryButton) {
                retryButton.addEventListener('click', fetchDashboard);
            }

            const clearCacheBtn = document.getElementById('clearCacheButton');
            if (clearCacheBtn) {
                clearCacheBtn.addEventListener('click', clearCache);
            }
        });

        function startMessageRotation() {
            const messageElement = document.getElementById('loadingMessage');

            // Use requestAnimationFrame for better performance
            let lastUpdate = 0;
            const updateInterval = 3000; // 3 seconds

            function updateMessage(timestamp) {
                if (!lastUpdate || timestamp - lastUpdate >= updateInterval) {
                    messageElement.classList.add('fade');

                    // Use setTimeout for the fade transition
                    setTimeout(() => {
                        currentMessageIndex = (currentMessageIndex + 1) % loadingMessages.length;
                        messageElement.textContent = loadingMessages[currentMessageIndex];
                        messageElement.classList.remove('fade');
                        lastUpdate = timestamp;
                    }, 300);
                }

                if (messageInterval) {
                    requestAnimationFrame(updateMessage);
                }
            }

            // Start the animation loop
            messageInterval = true;
            requestAnimationFrame(updateMessage);
        }

        function stopMessageRotation() {
            messageInterval = false;
            // Clear countdown interval to prevent memory leak
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
        }

        // Fetch server-side cached JSON (instant load)
        async function fetchServerCache() {
            try {
                const response = await fetch(CACHE_FILE_URL, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });

                if (!response.ok) {
                    // Cache file doesn't exist or error
                    return null;
                }

                const cacheData = await response.json();

                // Check if cache has metadata
                if (cacheData._cache) {
                    // Check cache age
                    const cacheAge = Date.now() - cacheData._cache.timestamp_ms;
                    if (cacheAge > SERVER_CACHE_TTL) {
                        console.log('Server cache is stale, will fetch fresh data');
                        return null;
                    }

                    // Remove cache metadata before processing
                    delete cacheData._cache;

                    console.log('Loaded data from server cache (instant)');
                    return cacheData;
                }

                // If no metadata, use the data as-is
                return cacheData;

            } catch (error) {
                console.log('Server cache not available:', error.message);
                return null;
            }
        }

        // Process and render dashboard data
        function processAndRenderDashboard(jsonData) {
            try {
                if (typeof processWebhookData === 'function' && typeof renderDashboard === 'function') {
                    // Initialize theme preference
                    initializeThemePreference();

                    // Load theme preference for dashboard
                    if (typeof loadThemePreference === 'function') {
                        loadThemePreference();
                    }

                    // Process the data
                    const projectsData = processWebhookData(jsonData);

                    // Cache in localStorage for offline access
                    cacheDashboard(JSON.stringify({
                        data: jsonData,
                        processed: projectsData
                    }));

                    // Hide loading container
                    document.getElementById('loadingContainer').style.display = 'none';

                    // Render the dashboard
                    renderDashboard(projectsData);

                    stopMessageRotation();
                } else {
                    throw new Error('Dashboard scripts not loaded properly');
                }
            } catch (error) {
                handleError('Error processing dashboard data: ' + error.message);
            }
        }

        async function fetchDashboard() {
            // Hide error container, show loading
            document.getElementById('errorContainer').style.display = 'none';
            document.getElementById('loadingContainer').style.display = 'block';

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), TIMEOUT_MS);

                const response = await fetch(WEBHOOK_URL, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache',
                        'X-Requested-With': 'XMLHttpRequest',
                        'Sec-Fetch-Site': 'cross-site',
                        'Sec-Fetch-Mode': 'cors',
                        'Sec-Fetch-Dest': 'empty'
                    },
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const jsonResponse = await response.json();

                // Process the JSON data and render dashboard
                if (typeof processWebhookData === 'function' && typeof renderDashboard === 'function') {
                    // Initialize theme preference for loading page
                    initializeThemePreference();

                    // Load theme preference for dashboard
                    if (typeof loadThemePreference === 'function') {
                        loadThemePreference();
                    }

                    // Process the webhook data
                    const projectsData = processWebhookData(jsonResponse);

                    // Cache the processed data
                    cacheDashboard(JSON.stringify({
                        data: jsonResponse,
                        processed: projectsData
                    }));

                    // Hide loading container
                    document.getElementById('loadingContainer').style.display = 'none';

                    // Render the dashboard
                    renderDashboard(projectsData);
                } else {
                    throw new Error('Dashboard scripts not loaded properly');
                }

                stopMessageRotation();

            } catch (error) {
                if (error.name === 'AbortError') {
                    handleError('Request timed out. Please try again.');
                } else if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    handleError('Network error. Please check your connection.');
                } else {
                    handleError(error.message);
                }

                // Implement retry logic with exponential backoff
                if (retryCount < MAX_RETRIES - 1) {
                    retryCount++;
                    const delay = RETRY_DELAY * Math.pow(2, retryCount - 1);

                    // Show retry message with countdown timer
                    const messageElement = document.getElementById('loadingMessage');
                    if (messageElement) {
                        let countdown = Math.ceil(delay / 1000);
                        messageElement.textContent = `Retrying in ${countdown} seconds... (${retryCount}/${MAX_RETRIES})`;

                        // Store interval ID to clear later
                        countdownInterval = setInterval(() => {
                            countdown--;
                            if (countdown > 0) {
                                messageElement.textContent = `Retrying in ${countdown} seconds... (${retryCount}/${MAX_RETRIES})`;
                            } else {
                                clearInterval(countdownInterval);
                                countdownInterval = null;
                                messageElement.textContent = `Retrying... (${retryCount}/${MAX_RETRIES})`;
                            }
                        }, 1000);
                    }

                    setTimeout(fetchDashboard, delay);
                }
            }
        }

        function handleError(message) {
            stopMessageRotation();

            document.getElementById('loadingContainer').style.display = 'none';
            document.getElementById('errorContainer').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;

            // Show cache controls if available
            const cached = getCachedDashboard();
            if (cached) {
                document.getElementById('cacheControls').classList.remove('hidden');
                document.getElementById('cacheTime').textContent = new Date(cached.timestamp).toLocaleString();
            }
        }

        // Removed sanitizeHTML function - no longer needed for JSON response

        function cacheDashboard(data) {
            try {
                const cacheData = {
                    data: data,
                    timestamp: Date.now()
                };
                localStorage.setItem(CACHE_KEY, JSON.stringify(cacheData));
            } catch (error) {
                // Silently handle cache errors - non-critical functionality
            }
        }

        function getCachedDashboard() {
            try {
                const cached = localStorage.getItem(CACHE_KEY);
                if (!cached) return null;

                const cacheData = JSON.parse(cached);
                const now = Date.now();

                if (now - cacheData.timestamp > CACHE_TTL) {
                    localStorage.removeItem(CACHE_KEY);
                    return null;
                }

                return cacheData;
            } catch (error) {
                return null;
            }
        }

        function loadCachedDashboard(cachedData) {
            try {
                const parsed = JSON.parse(cachedData);

                if (typeof processWebhookData === 'function' && typeof renderDashboard === 'function') {
                    // Initialize theme preference for loading page
                    initializeThemePreference();

                    // Load theme preference for dashboard
                    if (typeof loadThemePreference === 'function') {
                        loadThemePreference();
                    }

                    // Use cached processed data if available, otherwise reprocess
                    const projectsData = parsed.processed || processWebhookData(parsed.data);

                    // Hide loading container
                    document.getElementById('loadingContainer').style.display = 'none';

                    // Render the dashboard
                    renderDashboard(projectsData);
                }
            } catch (error) {
                console.error('Failed to load cached dashboard:', error);
                fetchDashboard();
            }
            stopMessageRotation();
        }

        function clearCache() {
            localStorage.removeItem(CACHE_KEY);
            document.getElementById('cacheControls').classList.add('hidden');
            fetchDashboard();
        }

    </script>
</body>
</html>